/// <reference path="../Plugins/jquery-1.6.2-vsdoc.js" />
//var Users_All_Grid=
var Clients_ClientsList_Grid=(function() {
   var tblSource="proc_Clients", oTable;
   var tblContracts_Form=oDATA.Get("tblContracts_Form").Data;
   var tblUsers=oDATA.Get("tblUsers").Data;
   var fnGetContracts=function(Contracts) {
      if(Contracts==='-') { return '-'; }
      var ret="", ctr=Contracts.split("||");
      for(var i=0; i<ctr.length; i++) {
         var c=ctr[i].split('##');
         ret+="<div><b>"+c[0]+"</b> - "+tblContracts_Form.findColsByID(parseInt(c[1], 10), 1)+"</div>";
      }
      return ret;
   }
   var fnGetEvents=function(Events) {
      var ret=""; e=(Events.split("##"));
      if(e[0]!=="0") {
         ret="<div><b>"+e[0]+"</b>, Paskutinis: "+e[1]+"</div>";
      } else {
         ret="<div style='color:\"red\"'>0</div>";
      }
      if(e[2]!=='-') {
         var days=parseInt(e[3], 10), style="", t=e[2];
         if(days<1) { style="style='color:red'"; }
         else if((days<7)) { style="style='color:green'"; t+=", liko "+days+"d"; }
         //else{}
         ret+="<div "+style+">Sekantis:"+t+"</div>";
      }
      return ret;
   }
   var fnUploadsToButton_Events=function(e) {
      oCONTROLS.UploadDialog({ RecId: e.data.ID, UserId: UserData.Id(), tblUpdate: "tblClients_Events", AttachedFiles: "tblDocs_UploadedFiles_ofEvent",
         DialogTitle: e.data.Date+" įvykio dokumentai, darbuotojas - "+e.data.User,
         fnCallBack: function(files) {
            $(e.target).parent().find("span.ui-button-text").html(files.length).parent().closest("button").css("color", ((files.length)?"":"red"));
            oDATA.UpdateCell("tblClientEvents", false, e.data.ID, "UplFilesNo", files.length); //UpdateCell:(obj,tblToUpdate,id,field,NewVal)
         }
      })
   }
   var fnUploadsToButton_Clients=function(e) {
      oCONTROLS.UploadDialog({ RecId: e.data.ID, UserId: UserData.Id(), tblUpdate: "tblClients", AttachedFiles: "tblDocs_UploadedFiles_ofClient",
         DialogTitle: "Bylų prisegimas prie įmonės - "+e.data.Company,
         fnCallBack: function(files) {
            $(e.target).parent().find("span.ui-button-text").html(files.length).parent().closest("button").css("color", ((files.length)?"":"red"));
            oDATA.UpdateCell(tblSource, false, e.data.ID, "UplFilesNo", files.length); //UpdateCell:(obj,tblToUpdate,id,field,NewVal)
         }
      })
   }
   var fnRowCallBack_ClientEvents=function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
      $('td:eq(3)', nRow).html("<button "+((aData[4]===0)?"style='color:red'":"")+">"+aData[4]+"</button>").find("button")
            .button({ icons: { primary: "img16-attach"} }).click({ ID: aData[0], Date: aData[1], User: aData[2] }, fnUploadsToButton_Events);
      return nRow;
   }
   var fnAddNewEvent=function(p) {
      var fnLoadForm=function() {
         var NewEventHTML=oDATA.Get("NewEventHTML").replace('"ClientID_Value"', p.ClientID);
         opt={ objData: "tblClientEvents", DialogFormId: "divEventsDialog", Action: "Add", RenderHTML: NewEventHTML,
            Title: ("Naujo įvykio įvedimas klientui - "+p.ClientName), form: p.form, target: p.target,
            CallBackAfter: function(RowData) {
               var oTable=$("#tblEvents").dataTable();
               var oSettings=oTable.fnSettings();
               var aiNew=oTable.fnAddData(RowData);
               var tr=$(oSettings.aoData[aiNew[0]].nTr);

               //var ix=$("#tblEvents").dataTable().fnAddData(RowData);
               //var tr=$("#tblEvents tr:eq("+(ix[0]+1)+")"),
               var clr=tr.find("td").css("color");
               tr.css("color", "blue").animate({ color: clr }, 3000);
               fnRowCallBack_ClientEvents(tr[0], RowData);
               //               var aPos=oTable.fnGetPosition(opt.ClickedRow);
               //               oTable.fnUpdate(RowData, aPos, 0);
            }
         }
         new clsEditableForm(opt);
      }
      if(!oDATA.Get("NewEventHTML")) {
         $.post('/Clients/NewEventHTML', function(data) {
            oDATA.Set("NewEventHTML", data.Render)
            fnLoadForm();
         });
      } else { fnLoadForm(); }
   }
   var fnShowClient=function(e) {
      e.preventDefault();
      e.stopPropagation();
      var tr=$(e.target).closest('tr');
      new clsEditInPlaceForm({ url: '/Clients/ClientEvents', postPars: { ClientID: e.data.ID, onlyData: ((oDATA.Get("tblClient_prop"))?true:false) },
         formTitle: "Kliento - "+$(e.target).html()+" - įvykiai",
         //Buttons: { "Naujas įvykis": function() { fnAddNewEvent({ ClientID: e.data.ID, ClientName: $(e.target).html() }) } }, Dialogo apačioje
         EditableFormId: "divClientData",
         Grid: { DoomId: "tblEvents", Opt: { "bDestroy": true, fnRowCallback: fnRowCallBack_ClientEvents,
            GridButtons: { "Pridėti naują įvykį": { Action: function(opt) { fnAddNewEvent({ ClientID: e.data.ID, ClientName: $(e.target).html(), target: opt.target, form: opt.form }) },
               form: "Head", icon: "img16-add_new"
            }
            }
         }, Source: "tblClientEvents"
         }, fnUpdateSuccess: function(par) {
            if(par.eOpt.Field==="NextContactDate") {
               var Uid=UserData.Id();
               if(par.ctrl.next().data("ctrl").UserId!==Uid) {
                  par.ctrl.next().html(oDATA.Get("tblUsers").Data.findColsByID(Uid, [2, 3])); //Jeigu pakeite data, irašom nauja useri jei ne tas pats
                  $.post("/Update/editInPlace", { id: par.id, tbl: "tblClients", update_value: Uid, field: "NextContactUserID" });
               }
            }
         },         // ,  "bDestroy": true   "bRetrieve": true
         tblProp: "tblClient_prop", //nurodoma is kur imti editable propercius
         fnFieldsUpdatedCallBack: function(DataToSave) {//DataToSave: Data,Fields,id,DataTable
            $.post('/Clients/ClientsList1', { RecID: DataToSave.id }, function(jsonResp) {
               tr.children().unbind(); //Atkabinam visus eventus (nes jie pasilieka keiciant html);
               var RowData=jsonResp.proc_Clients.Data[0];
               tr.find("'td:eq(0)'").html(RowData[1]); //Pakeiciam ranka, nes fnRowCallback kisa i cia ta ka turi
               oDATA.UpdateRow(RowData, "proc_Clients", "Edit")
               fnRowCallback(tr[0], RowData);
            });
         }
      });
      return false;
   }
   var fnRowCallback=function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
      $('td:eq(1)', nRow).html("<a href='#'>"+aData[2]+"</a>").click({ ID: aData[0] }, fnShowClient); //Company Name
      $('td:eq(2)', nRow).html(fnGetContracts(aData[3])); //Contracts
      $('td:eq(3)', nRow).html(fnGetEvents(aData[4])); //Events
      $('td:eq(4)', nRow).html("<button "+((aData[5]===0)?"style='color:red'":"")+">"+aData[5]+"</button>").find("button")
         .button({ icons: { primary: "img16-attach"} }).click({ ID: aData[0], Company: aData[2] }, fnUploadsToButton_Clients);
      //.parent().next()//islipam is buttono
      //.editInPlace({ field_type: "textarea", default_text: "", show_buttons: false, params: "id="+aData[0]+"&tbl=tblContracts&field=Status_Description" });
      $(nRow).data("ID", aData[0]);
      //console.log("Init");
      return nRow;
   }
   //sDom: "rt", fnRowCallback: _fnRowCallback, fnHeaderCallback: _fnHeaderCallback,
   //   fnInitComplete: function() { t=this; setTimeout(function() { t.fnAdjustColumnSizing(); }, 5); }
   oTable=$('#tblGrid').clsGrid({// "aaSortingFixed": [[1, 'asc']],           //Del grupavimo
      //Header: [{ col: 4, span: 2, Name: "Įrašė" }, { col: 7, span: 2, Name: "Sutarties būklė"}],
      //Groups: { ColToGroup: 1, GroupCaption: { Tbl: "tblContracts_Form", ShowCols: [1, 2]} },
      fnRowCallback: fnRowCallback
   }, tblSource);
})//.call(this);
(function(){this.Contracts_New_Object=function(){var b,a;a=$("#NewContract");oCONTROLS.UpdatableForm(a);a.find("input[title], label[title], textarea[title]").qtip({position:{at:"top center",my:"bottom center"}});b=function(){return a.find("button:contains('I\u0161saugoti')").removeAttr("disabled").removeClass("ui-state-disabled")};$("<div style='width:53.3em;position:relative;height:2.2em;'><button style='position:absolute;top:.5em;right:0;'>I\u0161saugoti pakeitimus</button></div>").appendTo("#NewContractRightCol").find("button").click(function(){var d;
if(d=oGLOBAL.ValidateForm(a))return oGLOBAL.UpdateServer({Action:a.data("ctrl").NewRec?"Add":"Edit",DataToSave:d,CallBack:{Success:function(e,f){var c;c=e.ResponseMsg.ID?e.ResponseMsg.ID:0;oCONTROLS.UpdatableForm_toSaved(c,a);f.Action==="Add"&&$("#introduction").html("Sutartis Nr.:"+c);return $("#side-bar ul li a").filter("[data-action='Contracts_Other'],[data-action='Contracts_Unsigned'],[data-action='Contracts_Expired']").data("opt","refresh")}},Msg:{Success:{Add:"Nauja sutartis i\u0161saugota.\n Dabar galite prisegti prie sutarties susijusias bylas.",
Edit:"Pakeitimai sutartyje i\u0161saugoti"},Error:{Add:"Nepavyko i\u0161saugoti naujos sutarties",Edit:"Nepavyko i\u0161saugoti pakeitim\u00f8 sutartyje"}},BlockCtrl:a})}).button({disabled:true,icons:{primary:"img16-edit"}});a.find("input,#NewContract textarea").keypress(b);return a.find("input.ui-autocomplete-input").focus(b)}}).call(this);

(function(){this.Contracts_New_Other=function(){var b,a;a=$("#NewContract");oCONTROLS.UpdatableForm(a);a.find("input[title], label[title], textarea[title]").qtip({position:{at:"top center",my:"bottom center"}});b=function(){return a.find("button:contains('I\u0161saugoti')").removeAttr("disabled").removeClass("ui-state-disabled")};$("<div style='width:53.3em;position:relative;height:2.2em;'><button style='position:absolute;top:.5em;right:0;'>I\u0161saugoti pakeitimus</button></div>").appendTo("#NewContractRightCol").find("button").click(function(){var d;
if(d=oGLOBAL.ValidateForm(a))return oGLOBAL.UpdateServer({Action:a.data("ctrl").NewRec?"Add":"Edit",DataToSave:d,CallBack:{Success:function(e,f){var c;c=e.ResponseMsg.ID?e.ResponseMsg.ID:0;oCONTROLS.UpdatableForm_toSaved(c,a);f.Action==="Add"&&$("#introduction").html("Sutartis Nr.:"+c);return $("#side-bar ul li a").filter("[data-action='Contracts_Other'],[data-action='Contracts_Unsigned'],[data-action='Contracts_Expired']").data("opt","refresh")}},Msg:{Success:{Add:"Nauja sutartis i\u0161saugota.\n Dabar galite prisegti prie sutarties susijusias bylas.",
Edit:"Pakeitimai sutartyje i\u0161saugoti"},Error:{Add:"Nepavyko i\u0161saugoti naujos sutarties",Edit:"Nepavyko i\u0161saugoti pakeitim\u0173 sutartyje"}},BlockCtrl:a})}).button({disabled:true,icons:{primary:"img16-edit"}});a.find("input,#NewContract textarea").keypress(b);return a.find("input.ui-autocomplete-input").focus(b)}}).call(this);

var ContractsObjects_Grid=function(){var c=window.oGLOBAL.Action,d=function(b){oCONTROLS.UploadDialog({RecId:b.data.ID,UserId:UserData.Id(),tblUpdate:"tblContracts",AttachedFiles:"tblDocs_UploadedFilesObjects",fnCallBack:function(a){$(b.target).parent().find("span.ui-button-text").html(a.length).parent().closest("button").css("color",a.length?"":"red");oDATA.UpdateCell(c,false,b.data.ID,6,a.length)}})};$("#tblGrid").clsGrid({Header:[{col:4,span:2,Name:"\u012era\u0161\u0117"},{col:7,span:2,Name:"Sutarties b\u016bkl\u0117"}],
Groups:{ColToGroup:1,GroupCaption:{Tbl:"tblUsers",ShowCols:[1,2,3]}},fnRowCallback:function(b,a){$("td:eq(5)",b).html("<button "+(a[6]===0?"style='color:red'":"")+">"+a[6]+"</button>").find("button").button({icons:{primary:"img16-attach"}}).click({ID:a[0]},d);return b}},c)};

var ContractsOther_Grid=function(){var c=window.oGLOBAL.Action,d=function(b){oCONTROLS.UploadDialog({RecId:b.data.ID,UserId:UserData.Id(),tblUpdate:"tblContracts",AttachedFiles:"tblDocs_UploadedFilesOther",fnCallBack:function(a){$(b.target).parent().find("span.ui-button-text").html(a.length).parent().closest("button").css("color",a.length?"":"red");oDATA.UpdateCell(c,false,b.data.ID,8,a.length)}})};$("#tblGrid").clsGrid({Groups:{ColToGroup:1,GroupCaption:{Tbl:"tblContracts_Form",ShowCols:[1,2]}},
fnRowCallback:function(b,a){$("td:eq(6)",b).html("<button "+(a[8]===0?"style='color:red'":"")+">"+a[8]+"</button>").find("button").button({icons:{primary:"img16-attach"}}).click({ID:a[0]},d);return b}},c)};

var ContractsUnsigned_Grid=function(){var c=window.oGLOBAL.Action,f=function(b){oCONTROLS.UploadDialog({RecId:b.data.ID,UserId:UserData.Id(),tblUpdate:"tblContracts",AttachedFiles:"tblDocs_UploadedFilesUnsigned",fnCallBack:function(a){$(b.target).parent().find("span.ui-button-text").html(a.length).parent().closest("button").css("color",a.length?"":"red");oDATA.UpdateCell(c,false,b.data.ID,7,a.length)}})};$("#tblGrid").clsGrid({Header:[{col:5,span:2,Name:"\u012era\u0161\u0117"},{col:8,span:2,Name:"Sutarties b\u016bkl\u0117"}],
fnRowCallback:function(b,a){var d=a[1]==="Kt.pasl."?"tblContracts":"tblClients_Objects";$("td:eq(7)",b).html("<button "+(a[7]===0?"style='color:red'":"")+">"+a[7]+"</button>").find("button").button({icons:{primary:"img16-attach"}}).click({ID:a[0]},f).parent().next().MyEditInPlace({field_type:"textarea",default_text:"",id:a[0],tblUpdate:d,Field:"Status_Description",Title:"Pastaba apie sutarties b\u016bkl\u0119, spragtelkit nor\u0117dami pakeisti..",fnUpdateSuccess:function(e){oDATA.UpdateCell(c,false,
e.id,"Status_Description",e.ctrl.html())}});$("td:eq(9)",b).html("<button style='height:30px;'></button>").ButtonStatuses({ID:a[0],StatusID:a[9],enableEvents:true,tblSource:c,tblUpdate:d,FieldName:"StatusID"});return b}},c)};

var Title_MyEvents=function(){var c=$("#introduction").clone(),d=$("#introduction").next().clone();$("#main-copy").empty();if(oDATA.Get("Contracts_Unsigned").Data.length){c.clone().html("Tvarkomos sutartys").attr("id","h1Contracts_Unsigned").appendTo("#main-copy");d.clone().appendTo("#main-copy").find("#tblGrid").attr("id","grdContracts_Unsigned");var g=function(b){oCONTROLS.UploadDialog({RecId:b.data.ID,UserId:UserData.Id(),tblUpdate:"tblContracts",AttachedFiles:"tblDocs_UploadedFilesUnsigned",fnCallBack:function(a){$(b.target).parent().find("span.ui-button-text").html(a.length).parent().closest("button").css("color",
a.length?"":"red");oDATA.UpdateCell(tblSource,false,b.data.ID,7,a.length)}})},h=$("#grdContracts_Unsigned").clsGrid({Header:[{col:4,span:2,Name:"\u012era\u0161\u0117"},{col:7,span:2,Name:"Sutarties b\u016bkl\u0117"}],Groups:{ColToGroup:10,GroupCaption:{Tbl:"tblUsers",ShowCols:[1,2,3]}},fnRowCallback:function(b,a){var e=a[1]==="Kt.pasl."?"tblContracts":"tblClients_Objects";$("td:eq(7)",b).html("<button "+(a[7]===0?"style='color:red'":"")+">"+a[7]+"</button>").find("button").button({icons:{primary:"img16-attach"}}).click({ID:a[0]},
g).parent().next().MyEditInPlace({field_type:"textarea",default_text:"",id:a[0],tblUpdate:e,Field:"Status_Description",Title:"Pastaba apie sutarties b\u016bkl\u0119, spragtelkit nor\u0117dami pakeisti..",fnUpdateSuccess:function(f){oDATA.UpdateCell(tblSource,false,f.id,"Status_Description",f.ctrl.html())}});$("td:eq(9)",b).html("<button style='height:30px;'></button>").ButtonStatuses({ID:a[0],StatusID:a[9],enableEvents:true,tblSource:"Contracts_Unsigned",tblUpdate:e,FieldName:"StatusID"});return b}},
"Contracts_Unsigned")}if(oDATA.Get("tblClientEventsNew").Data.length){c.clone().html("Nauji \u012fvykiai per paskutinias 14 dien\u0173").attr("id","h1tblClientEvents").appendTo("#main-copy");d.clone().appendTo("#main-copy").find("#tblGrid").attr("id","grdtblClientEvents");var i=function(b){oCONTROLS.UploadDialog({RecId:b.data.ID,UserId:UserData.Id(),tblUpdate:"tblClients_Events",AttachedFiles:"tblNewClientEvents_UploadedFiles",fnCallBack:function(a){$(b.target).parent().find("span.ui-button-text").html(a.length).parent().closest("button").css("color",
a.length?"":"red");oDATA.UpdateCell("tblClientEventsNew",false,b.data.ID,9,a.length)}})};h=$("#grdtblClientEvents").clsGrid({fnRowCallback:function(b,a){$("td:eq(5)",b).html("<button "+(a[7]===0?"style='color:red'":"")+">"+a[7]+"</button>").find("button").button({icons:{primary:"img16-attach"}}).click({ID:a[0]},i);return b}},"tblClientEventsNew")}};

